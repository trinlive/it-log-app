<div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200 mb-6 transition-all">
    
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-3">
        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
            <i class="fa-solid fa-chart-pie text-blue-600"></i> 
            Dashboard <%= new Date().getFullYear() %>
        </h2>

        <div class="flex items-center gap-2 self-start md:self-auto">
             <span class="text-[10px] md:text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded font-mono border border-slate-200 whitespace-nowrap">
                <i class="fa-regular fa-clock mr-1"></i><%= formatSyncTime(lastSyncTime) %>
            </span>
        </div>
        
        <input type="file" id="importJsonInput" accept=".json" class="hidden" onchange="handleImport(this)">
    </div>

    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-6">
        
        <div class="p-4 rounded-lg bg-blue-50 border border-blue-100 flex flex-col justify-between h-full hover:shadow-sm transition-shadow">
            <div class="text-xs text-blue-600 font-semibold mb-1 uppercase tracking-wider">Total</div>
            <div class="text-xl md:text-2xl font-bold text-blue-800"><%= dashData.total %></div>
            <div class="text-[10px] text-blue-500 mt-1 truncate">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>

        <div class="p-4 rounded-lg bg-emerald-50 border border-emerald-100 flex flex-col justify-between h-full hover:shadow-sm transition-shadow">
            <div class="text-xs text-emerald-600 font-semibold mb-1 uppercase tracking-wider">Closed</div>
            <div class="text-xl md:text-2xl font-bold text-emerald-800"><%= dashData.closed %></div>
            <div class="text-[10px] text-emerald-500 mt-1 truncate">
                <% if(dashData.total > 0) { %>
                    <%= ((dashData.closed / dashData.total) * 100).toFixed(0) %>% Success
                <% } else { %>
                    0% Success
                <% } %>
            </div>
        </div>

        <div class="p-4 rounded-lg bg-amber-50 border border-amber-100 flex flex-col justify-between h-full hover:shadow-sm transition-shadow">
            <div class="text-xs text-amber-600 font-semibold mb-1 uppercase tracking-wider">Active</div>
            <div class="text-xl md:text-2xl font-bold text-amber-800"><%= dashData.active %></div>
            <div class="text-[10px] text-amber-500 mt-1 truncate">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
        </div>

        <div class="p-4 rounded-lg bg-indigo-50 border border-indigo-100 flex flex-col justify-between h-full hover:shadow-sm transition-shadow">
            <div class="text-xs text-indigo-600 font-semibold mb-1 uppercase tracking-wider">Cost</div>
            <div class="text-xl md:text-2xl font-bold text-indigo-800 truncate">
                ‡∏ø<%= dashData.totalCost.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %>
            </div>
            <div class="text-[10px] text-indigo-500 mt-1 truncate">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-2 bg-white p-4 rounded-lg border border-slate-100 shadow-sm">
            <h3 class="text-sm font-semibold text-slate-700 mb-4 text-center">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
            <div class="relative h-64 md:h-80 w-full">
                <canvas id="combinedChart"></canvas>
            </div>
        </div>

        <div class="bg-white p-4 rounded-lg border border-slate-100 shadow-sm">
            <h3 class="text-sm font-semibold text-slate-700 mb-4 text-center">üç© ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏á‡∏≤‡∏ô</h3>
            <div class="relative h-64 md:h-80 w-full flex justify-center">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- Data Preparation ---
    const chartData = <%- JSON.stringify(dashData) %>;
    const months = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];

    // ==========================================
    // ‚öôÔ∏è Function: Handle Import JSON (Validation + SweetAlert2)
    // ==========================================
    async function handleImport(input) {
        const file = input.files[0];
        if (!file) return;

        // üõ°Ô∏è 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏ü‡∏•‡πå
        if (!file.name.toLowerCase().endsWith('.json')) {
            await Swal.fire({
                icon: 'error',
                title: '‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .json ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'
            });
            input.value = ''; 
            return;
        }

        const reader = new FileReader();
        
        reader.onload = async (e) => {
            try {
                // üõ°Ô∏è 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á JSON
                const jsonContent = e.target.result;
                let data;
                try {
                    data = JSON.parse(jsonContent);
                } catch (err) {
                    throw new Error('‡πÑ‡∏ü‡∏•‡πå JSON ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Parse Error)');
                }

                // ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠ 1: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Array []
                if (!Array.isArray(data)) {
                    throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô List (Array) ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                }
                // ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠ 2: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ticket_no (‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å)
                if (data.length > 0 && !data[0].hasOwnProperty('ticket_no')) {
                    throw new Error('‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå "ticket_no"');
                }

                // üìù 3. ‡πÅ‡∏™‡∏î‡∏á Popup ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                const confirmResult = await Swal.fire({
                    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                    html: `
                        <div class="text-left text-sm text-slate-600 bg-slate-50 p-3 rounded border border-slate-200">
                            <p><b>üìÇ ‡πÑ‡∏ü‡∏•‡πå:</b> ${file.name}</p>
                            <p><b>üì¶ ‡∏Ç‡∏ô‡∏≤‡∏î:</b> ${(file.size / 1024).toFixed(2)} KB</p>
                            <p><b>üî¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</b> ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                        </div>
                        <p class="mt-2 text-xs text-slate-500">*‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà Ticket No ‡∏ã‡πâ‡∏≥ ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏°</p>
                    `,
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonColor: '#16a34a',
                    cancelButtonColor: '#d33',
                    confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Import',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                });

                if (!confirmResult.isConfirmed) {
                    input.value = ''; return;
                }

                // ‚è≥ 4. Loading & Sending
                Swal.fire({
                    title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const res = await fetch('/api/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                // ‚úÖ 5. Success
                if (result.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!',
                        text: result.message,
                        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                    });
                    window.location.reload();
                } else {
                    throw new Error(result.message);
                }

            } catch (err) {
                console.error(err);
                await Swal.fire({
                    icon: 'error',
                    title: 'Import ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
                    text: err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'
                });
            } finally {
                input.value = ''; // Reset input ‡πÄ‡∏™‡∏°‡∏≠
            }
        };
        reader.readAsText(file);
    }

    // ==========================================
    // üìä Chart 1: Combined Chart
    // ==========================================
    const ctxCombined = document.getElementById('combinedChart').getContext('2d');
    new Chart(ctxCombined, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [
                {
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô (Ticket)',
                    data: chartData.monthlyStats,
                    backgroundColor: '#3b82f6',
                    order: 2,
                    yAxisID: 'y',
                    borderRadius: 4
                },
                {
                    label: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                    data: chartData.monthlyCosts,
                    backgroundColor: '#f59e0b',
                    borderColor: '#f59e0b',
                    type: 'line',
                    borderWidth: 2,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#f59e0b',
                    pointRadius: 4,
                    order: 1,
                    yAxisID: 'y1',
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Responsive Chart
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.dataset.yAxisID === 'y1') {
                                // ‚úÖ Tooltip ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏î‡πâ‡∏ß‡∏¢
                                label += '‡∏ø' + context.raw.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                            } else {
                                label += context.raw + ' ‡∏á‡∏≤‡∏ô';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: { type: 'linear', display: true, position: 'left', beginAtZero: true },
                y1: { 
                    type: 'linear', display: true, position: 'right', beginAtZero: true, 
                    grid: { drawOnChartArea: false },
                    ticks: { callback: function(value) { return '‡∏ø' + value.toLocaleString('th-TH', { notation: "compact" }); } }
                },
                x: { grid: { display: false } }
            }
        }
    });

    // ==========================================
    // üç© Chart 2: Category Chart
    // ==========================================
    const ctxCat = document.getElementById('categoryChart').getContext('2d');
    const backgroundColors = [
        '#3b82f6', '#10b981', '#f59e0b', '#ef4444', 
        '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6',
        '#0ea5e9', '#84cc16', '#eab308', '#f43f5e',
        '#64748b', '#a8a29e', '#78716c', '#0f766e'
    ];

    new Chart(ctxCat, {
        type: 'doughnut',
        data: {
            labels: chartData.categoryLabels,
            datasets: [{
                data: chartData.categoryCounts,
                backgroundColor: backgroundColors,
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Responsive Chart
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: { 
                        boxWidth: 10, 
                        font: { size: 10 },
                        padding: 15,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const fillStyle = data.datasets[0].backgroundColor[i % data.datasets[0].backgroundColor.length];
                                    return {
                                        text: `${label} ${value}%`, 
                                        fillStyle: fillStyle,
                                        hidden: isNaN(data.datasets[0].data[i]),
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    } 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return (context.label || '') + ': ' + context.raw + '%';
                        }
                    }
                }
            },
            cutout: '60%'
        }
    });
</script>