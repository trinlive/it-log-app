<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
            <i class="fa-solid fa-chart-pie text-blue-600"></i> 
            Dashboard ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏õ‡∏µ <%= new Date().getFullYear() %>
        </h2>
        <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">
            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <%= new Date().toLocaleDateString('th-TH') %>
        </span>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="p-4 rounded-lg bg-blue-50 border border-blue-100">
            <div class="text-xs text-blue-600 font-semibold mb-1">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Total)</div>
            <div class="text-2xl font-bold text-blue-800"><%= dashData.total %></div>
            <div class="text-[10px] text-blue-500 mt-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</div>
        </div>
        <div class="p-4 rounded-lg bg-emerald-50 border border-emerald-100">
            <div class="text-xs text-emerald-600 font-semibold mb-1">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (Closed)</div>
            <div class="text-2xl font-bold text-emerald-800"><%= dashData.closed %></div>
            <div class="text-[10px] text-emerald-500 mt-1">
                <% if(dashData.total > 0) { %>
                    <%= ((dashData.closed / dashData.total) * 100).toFixed(1) %>% Success Rate
                <% } else { %>
                    0% Success Rate
                <% } %>
            </div>
        </div>
        <div class="p-4 rounded-lg bg-amber-50 border border-amber-100">
            <div class="text-xs text-amber-600 font-semibold mb-1">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Active)</div>
            <div class="text-2xl font-bold text-amber-800"><%= dashData.active %></div>
            <div class="text-[10px] text-amber-500 mt-1">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
        </div>
        <div class="p-4 rounded-lg bg-indigo-50 border border-indigo-100">
            <div class="text-xs text-indigo-600 font-semibold mb-1">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏° (Cost)</div>
            <div class="text-2xl font-bold text-indigo-800">
                ‡∏ø<%= dashData.totalCost.toLocaleString('th-TH', {maximumFractionDigits: 0}) %>
            </div>
            <div class="text-[10px] text-indigo-500 mt-1">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-2 bg-white p-4 rounded-lg border border-slate-100 shadow-sm">
            <h3 class="text-sm font-semibold text-slate-700 mb-4 text-center">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Tickets & Costs)</h3>
            <div class="h-80"> <canvas id="combinedChart"></canvas>
            </div>
        </div>

        <div class="bg-white p-4 rounded-lg border border-slate-100 shadow-sm h-fit">
            <h3 class="text-sm font-semibold text-slate-700 mb-4 text-center">üç© ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô (Categories %)</h3>
            <div class="h-64 flex justify-center">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const chartData = <%- JSON.stringify(dashData) %>;
    const months = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];

    // 1. ‚úÖ Config Combined Chart (‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏ß‡∏° 2 ‡πÅ‡∏Å‡∏ô)
    const ctxCombined = document.getElementById('combinedChart').getContext('2d');
    new Chart(ctxCombined, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [
                {
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô (Ticket)',
                    data: chartData.monthlyStats,
                    backgroundColor: '#3b82f6', // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤
                    order: 2, // ‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
                    yAxisID: 'y', // ‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
                    borderRadius: 4
                },
                {
                    label: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                    data: chartData.monthlyCosts,
                    backgroundColor: '#f59e0b', // ‡∏™‡∏µ‡∏™‡πâ‡∏°
                    borderColor: '#f59e0b',
                    type: 'line', // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏ï‡∏µ‡∏Å‡∏±‡∏ö‡πÅ‡∏ó‡πà‡∏á
                    borderWidth: 2,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#f59e0b',
                    pointRadius: 4,
                    order: 1, // ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                    yAxisID: 'y1', // ‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡πÅ‡∏Å‡∏ô‡∏Ç‡∏ß‡∏≤
                    tension: 0.3 // ‡πÄ‡∏™‡πâ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏á‡∏™‡∏ß‡∏¢‡πÜ
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.dataset.yAxisID === 'y1') {
                                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Å‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà ‡∏ø
                                label += '‡∏ø' + context.raw.toLocaleString('th-TH');
                            } else {
                                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Å‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô
                                label += context.raw + ' ‡∏á‡∏≤‡∏ô';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô (Ticket)' },
                    beginAtZero: true
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: '‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)' },
                    beginAtZero: true,
                    grid: {
                        drawOnChartArea: false, // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏Å‡∏ô‡∏Ç‡∏ß‡∏≤ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏•‡∏≤‡∏¢‡∏ï‡∏≤
                    },
                    ticks: {
                        callback: function(value) {
                            return '‡∏ø' + value.toLocaleString('th-TH', { notation: "compact" });
                        }
                    }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    // 2. Config Doughnut Chart (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πä‡∏∞)
    const ctxCat = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctxCat, {
        type: 'doughnut',
        data: {
            labels: chartData.categoryLabels,
            datasets: [{
                data: chartData.categoryCounts,
                backgroundColor: [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', 
                    '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'
                ],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'bottom', 
                    labels: { boxWidth: 10, font: { size: 10 } } 
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) label += ': ';
                            label += context.raw + '%';
                            return label;
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });
</script>